<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Điểm Vovinam - Đồng Bộ Real-time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0d0d0d;
            font-family: 'Inter', sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            overflow: auto;
        }

        .scoreboard-wrapper {
            width: 100%;
            max-width: 100vh * (16 / 9);
            aspect-ratio: 16 / 9;
            min-height: 500px;
            max-height: 90vh;
        }

        .scoreboard-container {
            width: 100%;
            height: 100%;
            border: 4px solid #ff0000;
            box-shadow: 0 0 40px rgba(255, 0, 0, 0.5);
            background-color: #000000;
            padding: 2% 4%;
            box-sizing: border-box;
            position: relative;
        }

        .large-score {
            font-size: 15vw;
            line-height: 1;
            font-weight: 900;
            text-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);
        }
        @media (min-width: 1200px) { .large-score { font-size: 12rem; } }
        @media (max-width: 768px) { .large-score { font-size: 8rem; } }

        .timer-text {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -2px;
        }

        .score-red { background-color: #cc0000; cursor: pointer; transition: 0.1s; }
        .score-blue { background-color: #0000cc; cursor: pointer; transition: 0.1s; }

        .timer-box {
            background-color: #222;
            border: 2px solid #555;
            min-width: 200px;
        }

        .break-time-overlay {
            background-color: #333;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 8px 16px;
            border-radius: 8px;
            border: 3px solid white;
            z-index: 50;
        }

        /* Đèn báo trạng thái kết nối */
        #connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: gray;
        }
    </style>
</head>
<body>

    <div class="scoreboard-wrapper">
        <div id="connection-status" title="Chưa kết nối server"></div>
        <div class="scoreboard-container rounded-lg">
            <div class="flex flex-col items-center mb-4 space-y-1">
                <div class="flex justify-between w-full text-lg font-semibold px-4 md:px-8">
                    <span class="text-gray-300">Match: <span id="match-number">21</span></span>
                    <span class="text-gray-300">Final</span>
                    <span class="text-gray-300"><span id="category">72kg Male</span></span>
                </div>
            </div>

            <div class="flex relative flex-grow h-auto">
                <div class="w-1/12 text-left pr-2 hidden sm:block">
                    <div id="rf-list-red" class="space-y-1 text-sm md:text-base font-mono mt-4"></div>
                </div>

                <div class="flex-grow flex relative">
                    <div id="red-score-block" class="score-red w-1/2 flex flex-col justify-center items-center rounded-l-lg border-r-4 border-black pt-10 pb-10" onclick="increaseScore('red')">
                        <span id="red-score" class="large-score">0</span>
                    </div>
                    
                    <div id="blue-score-block" class="score-blue w-1/2 flex flex-col justify-center items-center rounded-r-lg border-l-4 border-black pt-10 pb-10" onclick="increaseScore('blue')">
                        <span id="blue-score" class="large-score">0</span>
                    </div>

                    <div class="absolute left-1/2 transform -translate-x-1/2 -top-10 z-20">
                        <div class="timer-box rounded-lg px-6 py-2 text-center shadow-lg">
                            <p class="text-sm font-medium text-gray-400 uppercase" id="match-status">READY</p>
                            <p id="timer-display" class="timer-text">01:30</p>
                        </div>
                    </div>

                    <div id="break-time-message" class="break-time-overlay hidden">Break Time</div>
                </div>

                <div class="w-1/12 text-right pl-2 hidden sm:block">
                    <div id="rf-list-blue" class="space-y-1 text-sm md:text-base font-mono mt-4"></div>
                </div>
            </div>

            <div class="flex justify-between items-end mt-4 px-2 md:px-8">
                <div class="text-left text-sm md:text-base space-y-1">
                    <p>Remind: <span id="red-remind" class="text-yellow-400 font-bold">0</span></p>
                    <p>Warned: <span id="red-warned" class="text-yellow-400 font-bold">0</span></p>
                    <p>Medical: <span id="red-medical" class="text-yellow-400 font-bold">0</span></p>
                </div>

                <div class="flex-grow flex justify-center space-x-16 text-sm md:text-base font-bold">
                    <p id="red-boutsRd" class="text-gray-400">0 bouts/Rd</p>
                    <p id="blue-boutsRd" class="text-gray-400">0 bouts/Rd</p>
                </div>

                <div class="text-right text-sm md:text-base space-y-1">
                    <p>Remind: <span id="blue-remind" class="text-yellow-400 font-bold">0</span></p>
                    <p>Warned: <span id="blue-warned" class="text-yellow-400 font-bold">0</span></p>
                    <p>Medical: <span id="blue-medical" class="text-yellow-400 font-bold">0</span></p>
                </div>

                <button id="reset-all-btn" class="absolute right-0 bottom-0 mr-4 md:mr-8 bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-all">RESET ALL</button>
                <button id="edit-btn" class="absolute right-0 bottom-0 mr-4 md:mr-8 -translate-x-32 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-all">EDIT</button>
            </div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH SOCKET ---
        // Thay địa chỉ IP bên dưới bằng IP của máy tính chạy server (ví dụ: 192.168.1.15)
        const SERVER_URL = "http://localhost:3000"; 
        const socket = io(SERVER_URL);

        let state = {
            score: { red: 0, blue: 0 },
            timer: 90,
            isRunning: false,
            status: "READY",
            fouls: {
                red: { remind: 0, warned: 0, medical: 0 },
                blue: { remind: 0, warned: 0, medical: 0 }
            },
            matchNumber: 21,
            category: "72kg Male"
        };

        let localInterval = null;
        const DURATION_SECONDS = 90;
        const $ = (id) => document.getElementById(id);

        // --- QUẢN LÝ ĐỒNG BỘ ---
        socket.on('connect', () => {
            $('connection-status').style.backgroundColor = 'green';
            $('connection-status').title = "Đã kết nối server";
        });

        socket.on('disconnect', () => {
            $('connection-status').style.backgroundColor = 'red';
        });

        // Nhận dữ liệu đồng bộ từ thiết bị khác
        socket.on('sync-state', (newState) => {
            // Cập nhật state cục bộ
            state = newState;
            
            // Xử lý interval cục bộ dựa trên trạng thái server gửi về
            if (state.isRunning && !localInterval) {
                startLocalTimer();
            } else if (!state.isRunning && localInterval) {
                clearInterval(localInterval);
                localInterval = null;
            }
            render();
        });

        function emitChange() {
            socket.emit('update-state', state);
        }

        // --- LOGIC ĐIỀU KHIỂN ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function render() {
            $('red-score').textContent = state.score.red;
            $('blue-score').textContent = state.score.blue;
            $('timer-display').textContent = formatTime(state.timer);
            $('red-remind').textContent = state.fouls.red.remind;
            $('red-warned').textContent = state.fouls.red.warned;
            $('red-medical').textContent = state.fouls.red.medical;
            $('blue-remind').textContent = state.fouls.blue.remind;
            $('blue-warned').textContent = state.fouls.blue.warned;
            $('blue-medical').textContent = state.fouls.blue.medical;
            $('match-number').textContent = state.matchNumber;
            $('category').textContent = state.category;

            const isBreak = state.status === "Break Time";
            $('break-time-message').classList.toggle('hidden', !isBreak);
            $('match-status').textContent = state.timer === 0 ? "MATCH ENDED" : (state.isRunning ? "RUNNING" : state.status);
            
            // RF List render (tĩnh)
            const rfList = [1,2,3,4,5];
            if ($('rf-list-red').children.length === 0) {
                $('rf-list-red').innerHTML = rfList.map(i => `<p>RF ${i} <span class="opacity-50">${i}</span></p>`).join('');
                $('rf-list-blue').innerHTML = rfList.map(i => `<p>RF ${i} <span class="opacity-50">${i}</span></p>`).join('');
            }
        }

        function startLocalTimer() {
            if (localInterval) clearInterval(localInterval);
            localInterval = setInterval(() => {
                if (state.timer > 0 && state.isRunning) {
                    state.timer--;
                    render();
                } else {
                    clearInterval(localInterval);
                    localInterval = null;
                    state.isRunning = false;
                    render();
                }
            }, 1000);
        }

        function toggleTimer() {
            state.isRunning = !state.isRunning;
            if (state.isRunning) {
                state.status = "RUNNING";
                startLocalTimer();
            } else {
                state.status = "PAUSED";
                clearInterval(localInterval);
                localInterval = null;
            }
            render();
            emitChange();
        }

        function increaseScore(team) {
            state.score[team]++;
            render();
            emitChange();
        }

        function decreaseScore(team) {
            if (state.score[team] > 0) {
                state.score[team]--;
                render();
                emitChange();
            }
        }

        function updateFoul(team, type) {
            state.fouls[team][type]++;
            if (type === 'remind' && state.fouls[team].remind >= 3) {
                state.fouls[team].warned++;
                state.fouls[team].remind = 0;
            }
            render();
            emitChange();
        }

        function resetAll() {
            if (confirm("Reset toàn bộ dữ liệu?")) {
                state.score = { red: 0, blue: 0 };
                state.timer = DURATION_SECONDS;
                state.isRunning = false;
                state.status = "READY";
                state.fouls = {
                    red: { remind: 0, warned: 0, medical: 0 },
                    blue: { remind: 0, warned: 0, medical: 0 }
                };
                render();
                emitChange();
            }
        }

        function editMatchInfo() {
            const m = prompt("Số trận:", state.matchNumber);
            const c = prompt("Hạng cân:", state.category);
            if (m) state.matchNumber = m;
            if (c) state.category = c;
            render();
            emitChange();
        }

        // --- SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            if (e.key.startsWith('F')) e.preventDefault();
            const team = e.ctrlKey ? 'blue' : 'red';
            switch(e.key) {
                case 'F1': toggleTimer(); break;
                case 'F4': increaseScore('red'); break;
                case 'F5': decreaseScore('red'); break;
                case 'F6': increaseScore('blue'); break;
                case 'F7': decreaseScore('blue'); break;
                case 'r': case 'R': updateFoul(team, 'remind'); break;
                case 'w': case 'W': updateFoul(team, 'warned'); break;
                case 'm': case 'M': updateFoul(team, 'medical'); break;
            }
        });

        window.onload = () => {
            $('reset-all-btn').onclick = resetAll;
            $('edit-btn').onclick = editMatchInfo;
            render();
        };
    </script>
</body>
</html>